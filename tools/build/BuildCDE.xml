<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Help"  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Import required targets and configuration items. -->
  <Import Project="bin\MSBuild.Community.Tasks.Targets"/>
  <Import Project="build.config"/>


  <!--
    Determine directory tree from values passed in at runtime

	$(WORKSPACE) - directory containing the source code.
	$(TEMPBASE) - Base path for temporary files (build output)
	$(BUILD_NUMBER) - Build number (generated by Jenkins)


	Calculated properites are
      $(SourceLocation) - Location of source files.
      $(OutputFolder) - Holding bin for compiled binaries.
      $(StagingLocation) - Copy of all files to be deployed.
	  $(ConfigFileLocation) - Location for generating configuration files.

  -->
  <PropertyGroup>
    <SourceLocation>$(Workspace)</SourceLocation>

	<TempBase>$(TEMP)\Build-$(BUILD_NUMBER)</TempBase>
	<OutputFolder>$(TempBase)\output\</OutputFolder>
    <StagingLocation>$(TempBase)\staging</StagingLocation>
	<ConfigFileLocation>$(StagingLocation)\_configFiles</ConfigFileLocation>

	<BuildName>$(branch)-$(TargetEnvironment)-$(BUILD_NUMBER)</BuildName>
  </PropertyGroup>




  <!--
    Build the solution and copy only the necessary files to the staging folder.
  -->
  <Target Name="Build">

    <!-- Clean up old output locations. -->
    <RemoveDir Directories="$(StagingLocation)" />
    <RemoveDir Directories="$(OutputFolder)" />
	<RemoveDir Directories="$(ConfigFileLocation)" />

    <!--
        A given target can only be run once. We need to build a list of sites, and we don't want to maintain a list of
        solution items, so we go out to a command shell and run a series of smaller builds.  For ease of maintenance,
        computed property values (e.g. output and staging paths) are passed to the inner build as command-line parameters.
        Because of command-line length limits, configured properties (e.g. version number) are allowed to be imported
        from the build.config.
    -->
    <Exec Command="for %%a in ($(CDE_Site_List)) do msbuild buildInner.xml /t:Build &quot;/p:CDE_Site=%%a;StagingLocation=$(StagingLocation);OutputFolder=$(OutputFolder);SourceLocation=$(SourceLocation);Revision=$(Revision);TargetEnvironment=$(TargetEnvironment)Branch=$(Branch)&quot;" />

	<!--
		Similar to the build, we want to execute the ConfigTransform target multiple times, with varying
		combinations of CDE sites, environments, and preview/live.
	-->
	<!--
    <Exec Command="for %%a in ($(CDE_Site_List)) do for %%b in ($(Config_Environment_List)) do for %%c in ($(Config_Site_List)) do msbuild buildInner.xml /nologo /t:ConfigTransform &quot;/p:CDE_Site=%%a;ENVIRON=%%b;SITE=%%c;ConfigFileLocation=$(ConfigFileLocation);SourceLocation=$(SourceLocation);Revision=$(Revision);TargetEnvironment=$(TargetEnvironment);Branch=$(Branch)&quot;" />
	-->
  </Target>

  <!--
	Create a ZIP file containing the build artifacts and upload it to GitHub.
  -->
  <Target Name="Upload" DependsOnTargets="ValidateProps">
	<Message Text="Copying deployment scripts" />
	<Copy
		SourceFiles="$(SourceLocation)\tools\build\resources\cdeDeploy.*"
		DestinationFolder="$(StagingLocation)"
		OverwriteReadOnlyFiles="true"
	/>
	<Copy
		SourceFiles="$(SourceLocation)\tools\build\resources\cdeBackup.ps1"
		DestinationFolder="$(StagingLocation)"
		OverwriteReadOnlyFiles="true"
	/>

	<Message Text="Creating $(TempBase)\$(BuildName).zip from $(StagingLocation)" />
	<Exec Command="powershell -ExecutionPolicy RemoteSigned -NonInteractive scripts\create-zip.ps1 -sourcePath &quot;$(StagingLocation)\*&quot;  -destinationPath &quot;$(TempBase)\$(BuildName).zip&quot;" />

	<Message Text="Creating tag $(BuildName)." />
	<Exec Command="git tag $(BuildName) $(COMMIT_ID)" />

	<Message Text="Uploading $(BuildName).zip to GitHub" />
	<Exec Command="powershell -ExecutionPolicy RemoteSigned -NonInteractive scripts\github-release.ps1 -tagname $(BuildName) -releaseName $(BuildName) -commitId $(COMMIT_ID) -IsPreRelease -releaseNotes \&quot;Automated build $(BuildName)\&quot; -artifactDirectory &quot;$(TempBase)&quot; -artifactFileName &quot;$(BuildName).zip&quot; -gitHubUsername $(GITHUB_USER) -gitHubRepository $(GITHUB_REPO)" />
  </Target>

  <!--
	Clean up after the build is complete.
  -->
  <Target Name="Cleanup">
	<RemoveDir Directories="$(TempBase)" />
  </Target>

  <!--
    Deploy the built code (.as?x and .dll) to the location set in
    the $(DeployLocation) value, defined in build.config.  (If the
    value is not defined, this step will be skipped.)
  -->
  <Target Name="Deploy" Condition="$(DeployLocation) != ''">

    <!--
        A given target can only be run once. We need to deploy multiple sites, so use a command shell
        to run a series of deploy operations.  See the Build target for addtional information
    -->
    <Exec IgnoreExitCode="true" Command="for %%a in ($(CDE_Site_List)) do msbuild buildInner.xml /t:Deploy /p:CDE_Site=%%a /p:StagingLocation=$(StagingLocation) /p:TargetEnvironment=$(TargetEnvironment) /p:ConfigFileLocation=$(ConfigFileLocation)" />
  </Target>



  <!-- This target validates properties that are expected to be passed into msbuild -->
  <Target Name="ValidateProps">
	<Error Condition=" '$(TargetEnvironment)'=='' "
          Text=" Missing required property [TargetEnvironment]" />

	<Error Condition=" '$(Branch)'=='' "
          Text=" Missing required property [Branch]" />

	<Error Condition=" '$(COMMIT_ID)'=='' "
          Text=" Missing required property [COMMIT_ID]" />

	<Error Condition=" '$(GITHUB_TOKEN)'=='' "
          Text=" Missing required property [GITHUB_TOKEN]" />

  </Target>

  <!--
    The "main" target which defines the list and order of other
    targets to be run.
  -->
  <Target Name="All" DependsOnTargets="ValidateProps">

	<Message Text="Building Branch: $(Branch) for target $(TargetEnvironment)" />

    <CallTarget Targets="Build"/>
	<CallTarget Targets="Upload"/>
    <CallTarget Targets="Cleanup"/>

	</Target>

  <Target Name="Help">
    <Message Text=" " />
    <Message Text="This is the CDE Build script" />
    <Message Text=" " />
    <Message Text="To run this script, enter the command:" />
    <Message Text=" " />
    <Message Text="  msbuild BuildCDE.xml /target:All /p:TargetEnvironment=%BuildEnvironment%;Branch=%BranchName%" />
    <Message Text="                BuildEnvironment - The system being used for the build." />
    <Message Text="                BranchName - The branch being built." />
	<Message Text=" " />
    <Message Text="            The TEMP and BUILD_NUMBER environment variables must also be set." />
    <Message Text=" " />
  </Target>

</Project>